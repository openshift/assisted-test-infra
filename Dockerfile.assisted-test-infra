FROM quay.io/edge-infrastructure/assisted-service:latest AS service

FROM quay.io/assisted-installer-ops/base-python:3.12

# A directory in the path with write permission even for non-root users
ENV GOPATH=/go
ENV GOCACHE=/go/.cache
ENV PATH=$PATH:/usr/local/go/bin:/go/bin:/tools/
ENV CURL_OPT='--retry 5 --connect-timeout 30'


ENV PACKER_VERSION=1.9.4
ENV TERRAFORM_VERSION=1.6.3
ENV GO_VERSION=1.18.1

WORKDIR /home/assisted-test-infra

RUN mkdir /tools --mode g+xw

# TODO: Remove once OpenShift CI supports it out of the box (see https://access.redhat.com/articles/4859371)
RUN chmod g+w /etc/passwd && \
    echo 'echo default:x:$(id -u):$(id -g):Default Application User:/alabama:/sbin/nologin\ >> /etc/passwd' > /usr/local/bin/fix_uid.sh && \
    chmod g+rwx /usr/local/bin/fix_uid.sh

# tune dnf to download more packages in parallel and from the closest mirror
RUN echo -e \
'fastestmirror=1\n\ 
max_parallel_downloads=10\n\
install_weak_deps=False' \
>> /etc/dnf/dnf.conf
# CRB repo is required for libvirt-devel

RUN dnf -y install --enablerepo=crb \
  make \
  gcc \
  curl-minimal \
  git \
  httpd-tools \
  jq \
  nss_wrapper \
  libvirt-client \
  guestfs-tools \
  libvirt-devel \
  libguestfs-tools \
  libxslt \
  xorriso \
   && dnf clean all

# Git checks if the user that owns the files on the filesystem match the
# current user.  We need to disable this check because tests in Prow are
# running with a random user.
RUN git config --system --add safe.directory '*'

RUN curl ${CURL_OPT} -Ls https://github.com/containers/podman/releases/download/v4.4.4/podman-remote-static.tar.gz | tar zxvf - -O > /tools/podman-remote3; \
    curl ${CURL_OPT} -Ls https://github.com/containers/podman/releases/download/v4.1.1/podman-remote-static.tar.gz | tar zxvf - -O > /tools/podman-remote4; \
    curl ${CURL_OPT} -Ls https://releases.hashicorp.com/packer/${PACKER_VERSION}/packer_${PACKER_VERSION}_linux_386.zip | zcat > /usr/bin/packer.io; \
    curl ${CURL_OPT} -Ls https://releases.hashicorp.com/terraform/${TERRAFORM_VERSION}/terraform_${TERRAFORM_VERSION}_linux_amd64.zip | zcat >  /usr/bin/terraform; \
    curl ${CURL_OPT} -Ls https://storage.googleapis.com/golang/go${GO_VERSION}.linux-amd64.tar.gz | tar -zxvf -  -C /usr/local/ go/bin/*; \
    chmod +x  /tools/podman-remote* /usr/bin/packer.io /usr/bin/terraform /usr/local/go/bin/* 

COPY --from=quay.io/ocp-splat/govc:v0.29.0 /govc /usr/local/bin
COPY requirements.txt requirements-dev.txt ./
COPY --from=service /clients/assisted_service_client-*.whl /build/pip/

RUN pip3 install --upgrade pip && \
    pip3 install --no-cache-dir -I -r ./requirements.txt -r ./requirements-dev.txt && \
    pip3 install --upgrade /build/pip/*

COPY . .

# init terraform in order to cache the provider
RUN source scripts/utils.sh && \
    retry -- terraform -chdir=/home/assisted-test-infra/terraform_files/equinix-ci-machine init && \
    retry -- terraform -chdir=/home/assisted-test-infra/terraform_files/oci-ci-machine init && \
    chgrp -R 0 /home/assisted-test-infra && \
    chmod -R g=u /home/assisted-test-infra

# setting pre-commit env
ENV PRE_COMMIT_HOME build
