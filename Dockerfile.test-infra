
FROM jimschubert/swagger-codegen-cli:2.3.1 AS swagger

# Generates bm-inventory-client
RUN wget https://raw.githubusercontent.com/filanov/bm-inventory/master/swagger.yaml -O /swagger.yaml && \
    sed -i '/pattern:/d' /swagger.yaml && \
	echo '{"packageName" : "bm_inventory_client", "packageVersion": "1.0.0"}' > /config.json

RUN /docker-entrypoint.sh generate --lang python --config /config.json --output /bm-inventory-client --input-spec /swagger.yaml

FROM centos:8

RUN yum -y install make python3 libvirt-client libvirt-devel gcc unzip wget curl git python3-devel && yum clean all;

RUN wget `wget https://www.terraform.io/downloads.html -q -O - | grep -oP "(https://releases.hashicorp.com/terraform/.*linux_amd64\.zip)(?=\")" | head -n 1` && unzip terraform*.zip -d /usr/bin/ && rm -rf terraform*.zip

RUN curl -Lo minikube https://storage.googleapis.com/minikube/releases/v1.10.1/minikube-linux-amd64 \
  && chmod +x minikube && mkdir -p /usr/local/bin/ && install minikube /usr/local/bin/
RUN curl -Lo kubectl https://storage.googleapis.com/kubernetes-release/release/v1.17.0/bin/linux/amd64/kubectl && chmod +x kubectl && mv kubectl /usr/bin/

ENV PATH /usr/local/go/bin:$PATH
RUN mkdir -p ~/.terraform.d/plugins
RUN wget https://github.com/dmacvicar/terraform-provider-libvirt/releases/download/v0.6.2/terraform-provider-libvirt-0.6.2+git.1585292411.8cbe9ad0.Fedora_28.x86_64.tar.gz \
 && tar -C ~/.terraform.d/plugins  -xf terraform-provider-libvirt-0.6.2+git.1585292411.8cbe9ad0.Fedora_28.x86_64.tar.gz \
 && rm -rf terraform-provider-libvirt-0.6.2+git.1585292411.8cbe9ad0.Fedora_28.x86_64.tar.gz

COPY requirements.txt /tmp/
RUN pip3 install --no-cache-dir -r /tmp/requirements.txt

# Installing bm-inventory-client
COPY --from=swagger bm-inventory-client/ /root/bm-inventory-client
RUN cd /root/bm-inventory-client/ && python3 setup.py sdist && pip3 install dist/bm-inventory-client-1.0.0.tar.gz && rm -rf /root/bm-inventory-client

# Installing pre-commit
COPY .pre-commit-config.yaml /build/
RUN cd /build && git init . && pre-commit install-hooks
